<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DepÃ³sito Dashboard</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111826;
      --card2:#0f1724;
      --text:#e6edf3;
      --muted:#9aa4b2;
      --line:rgba(255,255,255,.08);
      --good:#1f9d55;
      --warn:#e0a800;
      --bad:#d64545;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 30% -10%, rgba(42,82,152,.25), transparent 60%),
                  radial-gradient(900px 700px at 90% 20%, rgba(38,166,154,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      padding: 22px 22px 28px;
      max-width: 1500px;
      margin: 0 auto;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 14px;
    }
    .title{
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .meta{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:12px;
      align-items:center;
    }
    .pill{
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.03);
    }
    /* FIX: indicador visual de Ãºltimo refresco */
    .pill.stale{ border-color: rgba(214,69,69,.45); color: #ffb3b3; }
    #btnSync{
      border: 1px solid var(--line);
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size: 12px;
      font-family: inherit;
      cursor: pointer;
      transition: background .15s, border-color .15s;
    }
    #btnSync:hover:not(:disabled){ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.2); }
    #btnSync:disabled{ opacity: .45; cursor: not-allowed; }
    #btnSync.syncing{ border-color: rgba(38,166,154,.5); color: #7eecd8; }
    #btnSync.ok    { border-color: rgba(31,157,85,.5);  color: #b5f5cf; }
    #btnSync.err   { border-color: rgba(214,69,69,.5);  color: #ffb3b3; }

    .grid-kpi{
      display:grid;
      grid-template-columns: repeat(5, minmax(180px, 1fr));
      gap: 12px;
      margin: 12px 0 14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px 12px;
      min-height: 88px;
    }
    .kpi-label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .kpi-value{
      font-size: 34px;
      font-weight: 800;
      line-height: 1;
      letter-spacing: -0.6px;
    }
    .kpi-sub{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .badge{
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      white-space: nowrap;
    }
    .badge.good{ color: #b5f5cf; border-color: rgba(31,157,85,.35); background: rgba(31,157,85,.12); }
    .badge.warn{ color: #ffe8a3; border-color: rgba(224,168,0,.35); background: rgba(224,168,0,.12); }
    .badge.bad { color: #ffb3b3; border-color: rgba(214,69,69,.35); background: rgba(214,69,69,.12); }

    .grid-bottom{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    .card-title{
      font-size: 14px;
      font-weight: 750;
      margin: 0 0 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .card-title span{
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
    }
    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td{
      text-align:left;
      padding: 10px 8px;
      border-top: 1px solid var(--line);
      vertical-align: top;
    }
    th{
      color: var(--muted);
      font-weight: 650;
      border-top: none;
      padding-top: 6px;
    }
    td.num, th.num{ text-align:right; }
    .muted{ color: var(--muted); }
    .row-rank{
      width: 30px;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }
    .sku{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #c7d2fe;
    }
    .name{ font-weight: 650; }
    .empty{
      padding: 14px 10px;
      color: var(--muted);
      border-top: 1px solid var(--line);
    }

    /* FIX: barra de progreso del countdown */
    .refresh-bar-wrap{
      height: 2px;
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 14px;
    }
    .refresh-bar{
      height: 100%;
      background: rgba(38,166,154,.6);
      transition: width .9s linear;
    }

    /* â”€â”€ GrÃ¡fico de flujo â”€â”€ */
    .card-flow{
      margin: 0 0 12px;
    }
    .flow-bars{
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
    }
    .flow-row{
      display: grid;
      grid-template-columns: 130px 1fr 56px;
      align-items: center;
      gap: 10px;
    }
    .flow-label{
      font-size: 12px;
      color: var(--muted);
      text-align: right;
      white-space: nowrap;
    }
    .flow-track{
      height: 22px;
      background: rgba(255,255,255,.04);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    .flow-fill{
      height: 100%;
      border-radius: 6px;
      transition: width .6s cubic-bezier(.4,0,.2,1);
      position: relative;
    }
    .flow-fill::after{
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent 60%, rgba(255,255,255,.08));
      border-radius: inherit;
    }
    .flow-fill.prep  { background: linear-gradient(90deg, #3b5fc0, #5b7fe0); }
    .flow-fill.desp  { background: linear-gradient(90deg, #b07d12, #e0a800); }
    .flow-fill.env   { background: linear-gradient(90deg, #1a7a41, #26a65b); }
    .flow-pct{
      font-size: 13px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      text-align: right;
      color: var(--text);
    }
    .flow-count{
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }
    .flow-total{
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      text-align: right;
    }

    @media (max-width: 1200px){
      .grid-kpi{ grid-template-columns: repeat(2, minmax(180px, 1fr)); }
      .grid-bottom{ grid-template-columns: 1fr; }
      .flow-row{ grid-template-columns: 100px 1fr 48px; }
    }

    /* â”€â”€ Pedidos pendientes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pending-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .filter-btn {
      padding: 5px 14px;
      border-radius: 20px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      transition: all .15s;
    }
    .filter-btn.active {
      background: rgba(56,139,253,.18);
      border-color: rgba(56,139,253,.5);
      color: #58a6ff;
    }
    .pending-search {
      flex: 1;
      min-width: 180px;
      padding: 5px 12px;
      border-radius: 20px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size: 13px;
      outline: none;
    }
    .pending-search:focus { border-color: rgba(56,139,253,.5); }
    .pending-table-wrap {
      max-height: 460px;
      overflow-y: auto;
    }
    .pending-table-wrap table { width: 100%; border-collapse: collapse; }
    .pending-table-wrap th {
      position: sticky;
      top: 0;
      background: var(--card);
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .5px;
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid var(--line);
    }
    .pending-table-wrap td {
      padding: 8px 10px;
      font-size: 13px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }
    .pending-table-wrap tr:last-child td { border-bottom: none; }
    .pending-table-wrap tr:hover td { background: rgba(255,255,255,.03); }
    .order-id { font-weight: 600; color: #58a6ff; font-family: monospace; font-size: 13px; }
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }
    .status-prep  { background: rgba(56,139,253,.15); color:#58a6ff; }
    .status-embal { background: rgba(255,193,7,.15);  color:#ffc107; }
    .status-desp  { background: rgba(56,211,159,.15); color:#3dd68c; }
    .products-list { font-size: 12px; color: var(--muted); line-height: 1.6; }
    .mins-badge {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 8px;
      white-space: nowrap;
    }
    .mins-ok   { background: rgba(56,211,159,.12); color:#3dd68c; }
    .mins-warn { background: rgba(224,168,0,.12);  color:#e0a800; }
    .mins-bad  { background: rgba(214,69,69,.15);  color:#d64545; }
    .card-wide { grid-column: 1 / -1; }


    /* â”€â”€ Modo TV (?modo=tv) â€” fluido, basado en vw/vh â”€â”€â”€â”€â”€â”€â”€â”€ */
    body.tv-mode {
      overflow: hidden;
      height: 100vh;
    }
    body.tv-mode .wrap {
      padding: 1.2vh 1.8vw;
      max-width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      gap: 0;
    }
    body.tv-mode .topbar      { margin-bottom: 0.8vh; flex-shrink: 0; }
    body.tv-mode .title       { font-size: clamp(16px, 1.8vw, 28px); }
    body.tv-mode .meta        { font-size: clamp(11px, 1vw, 15px); }
    body.tv-mode .pill        { padding: 0.4vh 0.8vw; font-size: clamp(11px, 1vw, 15px); }
    body.tv-mode #btnSync     { display: none; }
    body.tv-mode .refresh-bar-wrap { margin-bottom: 0.6vh; flex-shrink: 0; }

    body.tv-mode .alert-banner {
      padding: 1vh 1.5vw;
      margin-bottom: 0.8vh;
      flex-shrink: 0;
      cursor: default;
      pointer-events: none;
    }
    body.tv-mode .alert-icon  { font-size: clamp(18px, 2vw, 32px); }
    body.tv-mode .alert-title { font-size: clamp(14px, 1.5vw, 22px); }
    body.tv-mode .alert-sub   { font-size: clamp(11px, 1vw, 16px); margin-top: 0.3vh; }
    body.tv-mode .alert-expand { display: none; }
    body.tv-mode .alert-detail { display: none !important; }

    body.tv-mode .grid-kpi {
      grid-template-columns: repeat(5, 1fr);
      gap: 0.6vw;
      margin: 0 0 0.8vh;
      flex-shrink: 0;
    }
    body.tv-mode .card {
      padding: 1vh 1.2vw;
      min-height: 0;
    }
    body.tv-mode .kpi-label   { font-size: clamp(11px, 1vw, 15px); margin-bottom: 0.5vh; }
    body.tv-mode .kpi-value   { font-size: clamp(28px, 4vw, 62px); }
    body.tv-mode .kpi-sub     { font-size: clamp(10px, 0.9vw, 14px); margin-top: 0.4vh; }
    body.tv-mode .badge       { font-size: clamp(10px, 0.9vw, 13px); padding: 2px 6px; }

    body.tv-mode .card-flow   { margin-bottom: 0.8vh; flex-shrink: 0; }
    body.tv-mode .card-title  { font-size: clamp(12px, 1.2vw, 17px); margin-bottom: 0.6vh; }
    body.tv-mode .flow-label  { font-size: clamp(11px, 1vw, 14px); }
    body.tv-mode .flow-track  { height: clamp(16px, 2vh, 28px); }
    body.tv-mode .flow-pct    { font-size: clamp(12px, 1.2vw, 17px); }
    body.tv-mode .flow-count  { font-size: clamp(10px, 0.9vw, 13px); }
    body.tv-mode .flow-row    { grid-template-columns: 10vw 1fr 4vw; gap: 0.5vw; }
    body.tv-mode .flow-bars   { gap: 0.5vh; }

    body.tv-mode .grid-bottom {
      grid-template-columns: 1fr 1fr;
      gap: 0.6vw;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    body.tv-mode .grid-bottom .card {
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    body.tv-mode .grid-bottom .card-title {
      flex-shrink: 0;
    }
    /* Mostrar solo las primeras 5 filas en TV */
    body.tv-mode .grid-bottom tbody tr:nth-child(n+6) { display: none; }
    body.tv-mode .grid-bottom table { font-size: clamp(12px, 1.1vw, 16px); }
    body.tv-mode .grid-bottom th    { font-size: clamp(10px, 0.9vw, 13px); padding: 0.5vh 0.6vw; }
    body.tv-mode .grid-bottom td    { padding: 0.8vh 0.6vw; }
    body.tv-mode .name  { font-size: clamp(12px, 1.1vw, 16px); }
    body.tv-mode .sku   { font-size: clamp(10px, 0.9vw, 13px); }

    /* Ocultar en TV: listado de pedidos, analytics */
    body.tv-mode .card-wide    { display: none; }
    body.tv-mode .grid-analytics { display: none; }

    /* Modo TV link */
    .tv-link {
      font-size: 11px;
      color: var(--muted);
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid var(--line);
    }
    .tv-link:hover { color: var(--text); border-color: rgba(255,255,255,.2); }


    /* â”€â”€ Alertas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .alert-banner {
      display: none;
      align-items: center;
      gap: 12px;
      background: linear-gradient(90deg, rgba(214,69,69,.18), rgba(214,69,69,.08));
      border: 1px solid rgba(214,69,69,.4);
      border-radius: var(--radius);
      padding: 12px 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: background .2s;
    }
    .alert-banner:hover { background: linear-gradient(90deg, rgba(214,69,69,.25), rgba(214,69,69,.12)); }
    .alert-banner.visible { display: flex; }
    .alert-icon { font-size: 22px; flex-shrink: 0; }
    .alert-text { flex: 1; }
    .alert-title { font-size: 15px; font-weight: 700; color: #ffb3b3; }
    .alert-sub   { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .alert-expand { font-size: 12px; color: var(--muted); flex-shrink: 0; }

    .alert-detail {
      display: none;
      background: rgba(214,69,69,.07);
      border: 1px solid rgba(214,69,69,.25);
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      max-height: 260px;
      overflow-y: auto;
      margin-top: -12px;
      margin-bottom: 12px;
    }
    .alert-detail.open { display: block; }
    .alert-detail table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .alert-detail th { font-size: 11px; color: var(--muted); padding: 8px 12px; border-bottom: 1px solid var(--line); }
    .alert-detail td { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,.04); }
    .alert-detail tr:last-child td { border-bottom: none; }
    .alert-mins { color: #ffb3b3; font-weight: 700; }

    /* â”€â”€ Productividad y tiempos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .grid-analytics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .bar-chart { margin-top: 8px; }
    .bar-row {
      display: grid;
      grid-template-columns: 70px 1fr 48px;
      align-items: center;
      gap: 8px;
      margin-bottom: 7px;
    }
    .bar-label { font-size: 12px; color: var(--muted); text-align: right; }
    .bar-track {
      height: 20px;
      background: rgba(255,255,255,.04);
      border-radius: 5px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      border-radius: 5px;
      background: linear-gradient(90deg, #3b5fc0, #58a6ff);
      transition: width .5s cubic-bezier(.4,0,.2,1);
    }
    .bar-val { font-size: 12px; font-weight: 700; text-align: right; color: var(--text); }

    .stage-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; }
    .stage-table th { font-size: 11px; color: var(--muted); padding: 6px 8px; border-bottom: 1px solid var(--line); text-align: left; }
    .stage-table td { padding: 9px 8px; border-bottom: 1px solid var(--line); }
    .stage-table tr:last-child td { border-bottom: none; }
    .stage-table td.num { text-align: right; }
    .stage-name { font-weight: 600; }
    .time-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
    }
    .time-good { background: rgba(56,211,159,.12); color: #3dd68c; }
    .time-warn { background: rgba(224,168,0,.12);  color: #e0a800; }
    .time-bad  { background: rgba(214,69,69,.12);  color: #d64545; }

    @media (max-width: 1200px) {
      .grid-analytics { grid-template-columns: 1fr; }
    }



    body.tv-mode .alert-title  { font-size: 18px; }
    body.tv-mode .grid-analytics { display: none; }


    /* â”€â”€ Analytics avanzados â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .grid-analytics-2 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .grid-analytics-3 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .units-big {
      font-size: 42px;
      font-weight: 800;
      line-height: 1;
      color: #58a6ff;
    }
    .units-sub { font-size: 13px; color: var(--muted); margin-top: 6px; }
    .rate-chart { margin-top: 8px; display: flex; align-items: flex-end; gap: 4px; height: 80px; }
    .rate-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .rate-bar {
      width: 100%;
      background: linear-gradient(180deg, #3b5fc0, #58a6ff);
      border-radius: 3px 3px 0 0;
      transition: height .4s cubic-bezier(.4,0,.2,1);
      min-height: 2px;
    }
    .rate-bar-label { font-size: 10px; color: var(--muted); white-space: nowrap; }
    .rate-bar-val   { font-size: 11px; font-weight: 700; }
    .peak-chart { margin-top: 8px; display: flex; align-items: flex-end; gap: 2px; height: 70px; }
    .peak-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; }
    .peak-bar {
      width: 100%;
      background: linear-gradient(180deg, #b07d12, #e0a800);
      border-radius: 2px 2px 0 0;
      min-height: 2px;
      transition: height .4s;
    }
    .peak-bar.highlight { background: linear-gradient(180deg, #d64545, #ff6b6b); }
    .peak-label { font-size: 9px; color: var(--muted); }
    .comparison-chart { margin-top: 8px; }
    .comp-row {
      display: grid;
      grid-template-columns: 36px 1fr 36px;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    .comp-day { color: var(--muted); text-align: center; }
    .comp-bars { display: flex; flex-direction: column; gap: 2px; }
    .comp-bar-row { display: flex; align-items: center; gap: 4px; }
    .comp-bar-fill {
      height: 8px;
      border-radius: 2px;
      transition: width .4s;
      min-width: 2px;
    }
    .comp-bar-fill.this { background: #58a6ff; }
    .comp-bar-fill.last { background: rgba(88,166,255,.3); }
    .comp-val { font-size: 11px; font-weight: 700; min-width: 24px; text-align: right; }
    .cancel-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; }
    .cancel-table th { font-size: 11px; color: var(--muted); padding: 5px 8px; border-bottom: 1px solid var(--line); }
    .cancel-table td { padding: 7px 8px; border-bottom: 1px solid var(--line); }
    .cancel-table tr:last-child td { border-bottom: none; }
    .backtrack-list { margin-top: 8px; max-height: 200px; overflow-y: auto; }
    .backtrack-item {
      display: flex; align-items: center; gap: 10px;
      padding: 7px 0; border-bottom: 1px solid var(--line); font-size: 13px;
    }
    .backtrack-item:last-child { border-bottom: none; }
    .backtrack-order { font-weight: 700; color: #58a6ff; font-family: monospace; }
    .backtrack-arrow { color: #d64545; font-weight: 700; }
    .ttfm-big { font-size: 36px; font-weight: 800; color: #3dd68c; line-height: 1; }
    .ttfm-median { font-size: 13px; color: var(--muted); margin-top: 6px; }
    @media (max-width: 1200px) {
      .grid-analytics-2 { grid-template-columns: 1fr 1fr; }
      .grid-analytics-3 { grid-template-columns: 1fr; }
    }
    body.tv-mode .grid-analytics-2,
    body.tv-mode .grid-analytics-3 { display: none; }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">DepÃ³sito Â· Dashboard</div>
      <div class="meta">
        <div class="pill" id="pillCountdown">PrÃ³ximo refresh en <span id="refreshCountdown">â€”</span>s</div>
        <div class="pill" id="pillServer">Servidor <span id="serverTime">â€”</span></div>
        <a class="tv-link" id="tvLink" href="/?modo=tv">ğŸ“º TV</a>
        <button id="btnSync" onclick="forceSync()">âŸ³ Sync ahora</button>
      </div>
    </div>

    <!-- FIX: barra visual de progreso del countdown -->
    <div class="refresh-bar-wrap">
      <div class="refresh-bar" id="refreshBar" style="width:100%"></div>
    </div>

    <div class="alert-banner" id="alertBanner" onclick="toggleAlertDetail()">
      <div class="alert-icon">ğŸš¨</div>
      <div class="alert-text">
        <div class="alert-title" id="alertTitle">â€”</div>
        <div class="alert-sub" id="alertSub">â€”</div>
      </div>
      <div class="alert-expand" id="alertExpand">â–¼ Ver detalle</div>
    </div>
    <div class="alert-detail" id="alertDetail"></div>

    <div class="grid-kpi">
      <div class="card">
        <div class="kpi-label">
          <div>En preparaciÃ³n</div>
          <div class="badge" id="badgePrep">â€”</div>
        </div>
        <div class="kpi-value" id="kpiPrep">â€”</div>
        <div class="kpi-sub muted">Nuevos + RecepciÃ³n + PreparaciÃ³n</div>
      </div>

      <div class="card">
        <div class="kpi-label">
          <div>Embalados</div>
          <div class="badge" id="badgePack">â€”</div>
        </div>
        <div class="kpi-value" id="kpiPack">â€”</div>
        <div class="kpi-sub muted">Puestos + "Embalado"</div>
      </div>

      <div class="card">
        <div class="kpi-label">
          <div>En despacho</div>
          <div class="badge" id="badgeShip">â€”</div>
        </div>
        <div class="kpi-value" id="kpiShip">â€”</div>
        <div class="kpi-sub muted">Transportes / Pickup</div>
      </div>

      <div class="card">
        <div class="kpi-label">
          <div>Despachados hoy</div>
          <div class="badge good">Enviado</div>
        </div>
        <div class="kpi-value" id="kpiShippedToday">â€”</div>
        <div class="kpi-sub muted">Pedidos Ãºnicos "Enviado" hoy</div>
      </div>

      <div class="card">
        <div class="kpi-label">
          <div>Atrasados +24h</div>
          <div class="badge" id="badgeLate">â€”</div>
        </div>
        <div class="kpi-value" id="kpiLate">â€”</div>
        <div class="kpi-sub muted">Edad promedio: <span id="kpiAvg">â€”</span> min</div>
      </div>
    </div>

    <div class="card card-flow">
      <div class="card-title">
        DistribuciÃ³n de pedidos activos
        <span id="flowTotal">â€”</span>
      </div>
      <div class="flow-bars">
        <div class="flow-row">
          <div>
            <div class="flow-label">A procesar</div>
            <div class="flow-count" id="flowPrepCount">â€”</div>
          </div>
          <div class="flow-track">
            <div class="flow-fill prep" id="flowPrepBar" style="width:0%"></div>
          </div>
          <div class="flow-pct" id="flowPrepPct">â€”</div>
        </div>
        <div class="flow-row">
          <div>
            <div class="flow-label">En despacho</div>
            <div class="flow-count" id="flowDespCount">â€”</div>
          </div>
          <div class="flow-track">
            <div class="flow-fill desp" id="flowDespBar" style="width:0%"></div>
          </div>
          <div class="flow-pct" id="flowDespPct">â€”</div>
        </div>
        <div class="flow-row">
          <div>
            <div class="flow-label">Enviados hoy</div>
            <div class="flow-count" id="flowEnvCount">â€”</div>
          </div>
          <div class="flow-track">
            <div class="flow-fill env" id="flowEnvBar" style="width:0%"></div>
          </div>
          <div class="flow-pct" id="flowEnvPct">â€”</div>
        </div>
      </div>
    </div>


    <div class="grid-bottom">
      <div class="card">
        <div class="card-title">
          <div>Top 10 artÃ­culos vendidos <span>(Ãºltimos 7 dÃ­as)</span></div>
          <span class="muted" id="topProductsMeta">â€”</span>
        </div>
        <div id="topProductsWrap"><div class="empty">Cargandoâ€¦</div></div>
      </div>

      <div class="card">
        <div class="card-title">
          <div>Top embaladores <span>(hoy)</span></div>
          <span class="muted" id="topPackersMeta">â€”</span>
        </div>
        <div id="topPackersWrap"><div class="empty">Cargandoâ€¦</div></div>
      </div>
    </div>

    <div class="card card-wide" style="margin-top:16px">
      <div class="card-title">
        <div>Pedidos activos <span id="pendingCount"></span></div>
        <span class="muted" id="pendingMeta">â€”</span>
      </div>
      <div class="pending-filters">
        <input class="pending-search" id="pendingSearch" type="text" placeholder="Buscar por pedido, producto o SKUâ€¦" oninput="filterPending()">
        <button class="filter-btn active" data-filter="all" onclick="setFilter('all',this)">Todos</button>
        <button class="filter-btn" data-filter="prep" onclick="setFilter('prep',this)">PreparaciÃ³n</button>
        <button class="filter-btn" data-filter="embal" onclick="setFilter('embal',this)">Embalado</button>
        <button class="filter-btn" data-filter="desp" onclick="setFilter('desp',this)">Despacho</button>
      </div>
      <div class="pending-table-wrap" id="pendingTableWrap">
        <div class="empty">Cargandoâ€¦</div>
      </div>
    </div>

    <div class="grid-analytics">
      <div class="card">
        <div class="card-title">
          <div>Productividad diaria <span>(Ãºltimos 7 dÃ­as)</span></div>
          <span class="muted" id="productivityMeta">â€”</span>
        </div>
        <div class="bar-chart" id="productivityChart"><div class="empty">Cargandoâ€¦</div></div>
      </div>
      <div class="card">
        <div class="card-title">
          <div>Tiempo promedio por etapa <span>(Ãºltimos 7 dÃ­as)</span></div>
          <span class="muted" id="stageTimesMeta">â€”</span>
        </div>
        <div id="stageTimesWrap"><div class="empty">Cargandoâ€¦</div></div>
      </div>
    </div>

    <!-- Grupo 1: Operativo inmediato -->
    <div class="grid-analytics-2">
      <div class="card">
        <div class="card-title"><div>Unidades en preparaciÃ³n</div><span class="muted" id="unitsPrepMeta">â€”</span></div>
        <div class="units-big" id="unitsPrepVal">â€”</div>
        <div class="units-sub" id="unitsPrepSub">â€” pedidos activos</div>
      </div>
      <div class="card">
        <div class="card-title"><div>Velocidad de despacho <span>(Ãºltimas 8hs)</span></div><span class="muted" id="dispatchRateMeta">â€”</span></div>
        <div class="rate-chart" id="dispatchRateChart"><div class="empty">Cargandoâ€¦</div></div>
      </div>
      <div class="card">
        <div class="card-title"><div>Sin movimiento +4hs <span id="stalledCount"></span></div><span class="muted" id="stalledMeta">â€”</span></div>
        <div class="backtrack-list" id="stalledList"><div class="empty">Cargandoâ€¦</div></div>
      </div>
    </div>

    <!-- Grupo 2: Tendencias -->
    <div class="grid-analytics-2">
      <div class="card">
        <div class="card-title"><div>Esta semana vs anterior</div><span class="muted" id="weeklyMeta">â€”</span></div>
        <div class="comparison-chart" id="weeklyChart"><div class="empty">Cargandoâ€¦</div></div>
      </div>
      <div class="card">
        <div class="card-title"><div>Hora pico <span>(Ãºltimos 7 dÃ­as)</span></div><span class="muted" id="peakMeta">â€”</span></div>
        <div class="peak-chart" id="peakChart"><div class="empty">Cargandoâ€¦</div></div>
      </div>
      <div class="card">
        <div class="card-title"><div>Cancelaciones <span>(Ãºltimos 7 dÃ­as)</span></div><span class="muted" id="cancelMeta">â€”</span></div>
        <div id="cancelWrap"><div class="empty">Cargandoâ€¦</div></div>
      </div>
    </div>

    <!-- Grupo 3: Calidad -->
    <div class="grid-analytics-3">
      <div class="card">
        <div class="card-title"><div>Pedidos que volvieron atrÃ¡s <span id="backtrackCount"></span></div><span class="muted" id="backtrackMeta">â€”</span></div>
        <div class="backtrack-list" id="backtrackList"><div class="empty">Cargandoâ€¦</div></div>
      </div>
      <div class="card">
        <div class="card-title"><div>Tiempo hasta primer movimiento <span>(Ãºltimos 7 dÃ­as)</span></div></div>
        <div class="ttfm-big" id="ttfmVal">â€”</div>
        <div class="ttfm-median" id="ttfmSub">â€”</div>
      </div>
    </div>

  </div>

  <script>

    // â”€â”€ Modo TV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const IS_TV = new URLSearchParams(location.search).get('modo') === 'tv';
    if (IS_TV) {
      document.body.classList.add('tv-mode');
      document.title = 'DepÃ³sito Â· TV';
      const tvLink = document.getElementById('tvLink');
      if (tvLink) { tvLink.textContent = 'âŠ Normal'; tvLink.href = '/'; }
    }

    // â”€â”€â”€ Utilidades â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const $ = (id) => document.getElementById(id);

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&",  "&amp;")
        .replaceAll("<",  "&lt;")
        .replaceAll(">",  "&gt;")
        .replaceAll('"',  "&quot;")
        .replaceAll("'",  "&#039;");
    }

    function fmtTime(iso) {
      try {
        return new Date(iso).toLocaleString("es-AR", { hour12: false });
      } catch (_) {
        return iso || "â€”";
      }
    }

    function badgeForLate(n) {
      if (n <= 0) return { cls: "good", text: "OK" };
      if (n <= 5) return { cls: "warn", text: "AtenciÃ³n" };
      return { cls: "bad", text: "CrÃ­tico" };
    }

    function setBadge(el, cls, text) {
      el.className = "badge " + (cls || "");
      el.textContent = text;
    }

    async function fetchJson(url, timeoutMs = 8000) {
      const ctrl = new AbortController();
      const tid = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const res = await fetch(url, { cache: "no-store", signal: ctrl.signal });
        if (!res.ok) throw new Error(`${url} â†’ ${res.status}`);
        return res.json();
      } finally {
        clearTimeout(tid);
      }
    }

    // â”€â”€â”€ Renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderTopProducts(items) {
      if (!items || items.length === 0) {
        return `<div class="empty">Sin datos todavÃ­a (corrÃ© /sync o esperÃ¡ el cron).</div>`;
      }
      const rows = items.map((it, idx) => `
        <tr>
          <td class="row-rank">${idx + 1}</td>
          <td>
            <div class="name">${escapeHtml(it.name || "")}</div>
            <div class="sku">${escapeHtml(it.sku || "")}</div>
          </td>
          <td class="num">${Number(it.units  || 0).toLocaleString("es-AR")}</td>
          <td class="num muted">${Number(it.orders || 0).toLocaleString("es-AR")}</td>
        </tr>`).join("");

      return `
        <table>
          <thead>
            <tr>
              <th style="width:32px">#</th>
              <th>ArtÃ­culo</th>
              <th class="num">Unid.</th>
              <th class="num">Pedidos</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    function renderTopPickers(items) {
      if (!items || items.length === 0) {
        return `<div class="empty">Sin datos todavÃ­a â€” esperÃ¡ el prÃ³ximo sync.</div>`;
      }
      const max = Math.max(...items.map(i => i.orders_picked), 1);
      const rows = items.map((it, idx) => `
        <tr>
          <td class="row-rank">${idx + 1}</td>
          <td>
            <div class="name">${escapeHtml(it.user || "")}</div>
          </td>
          <td class="num">${it.orders_picked}</td>
          <td style="width:80px">
            <div style="height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden">
              <div style="height:100%;width:${Math.round(it.orders_picked/max*100)}%;background:linear-gradient(90deg,#b07d12,#e0a800);border-radius:3px"></div>
            </div>
          </td>
        </tr>`).join("");
      return `
        <table>
          <thead>
            <tr>
              <th style="width:32px">#</th>
              <th>Usuario</th>
              <th class="num">Pedidos</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    function renderTopPackers(items) {
      if (!items || items.length === 0) {
        return `<div class="empty">Sin datos todavÃ­a (no hubo movimientos a Puestos o faltan eventos).</div>`;
      }
      const rows = items.map((it, idx) => `
        <tr>
          <td class="row-rank">${idx + 1}</td>
          <td class="name">${escapeHtml(it.packer || "")}</td>
          <td class="num">${Number(it.orders_packed || 0).toLocaleString("es-AR")}</td>
        </tr>`).join("");

      return `
        <table>
          <thead>
            <tr>
              <th style="width:32px">#</th>
              <th>Embalador</th>
              <th class="num">Pedidos</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    // â”€â”€â”€ Sync manual â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function forceSync() {
      const btn = $("btnSync");
      btn.disabled = true;
      btn.className = "syncing";
      btn.textContent = "âŸ³ Sincronizandoâ€¦";

      try {
        const res = await fetch("/sync", {
          method: "POST",
          headers: SYNC_SECRET ? { "X-Sync-Secret": SYNC_SECRET } : {},
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || res.status);

        btn.className = "ok";
        btn.textContent = `âœ“ ${data.orders_received} pedidos, ${data.changed} cambios`;

        // Refrescar KPIs y tops inmediatamente
        const m = await fetchJson("/api/metrics");
        lastSuccess = Date.now();
        consecutiveErrors = 0;
        tvHadFirstSuccess = true;
        markStale(false);
        resetTvReloadTimer();
        applyMetrics(m);
        await refreshTops();

      } catch (e) {
        console.error("force sync error", e);
        btn.className = "err";
        btn.textContent = "âœ• Error â€” ver consola";
      } finally {
        setTimeout(() => {
          btn.disabled  = false;
          btn.className = "";
          btn.textContent = "âŸ³ Sync ahora";
        }, 4000);
      }
    }

    // Secret inyectado por el servidor â€” no editar manualmente
    const SYNC_SECRET = "__SYNC_SECRET__";

    // â”€â”€â”€ LÃ³gica de refresco â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //
    // FIX: antes habÃ­a DOS setInterval paralelos que llamaban a /api/metrics,
    // uno cada 60 s (refreshAll completo) y otro cada 10 s solo para KPIs,
    // duplicando cÃ³digo y peticiones.
    // Ahora hay UN solo ciclo: KPIs cada `kpiIntervalMs`, tops cada vez que
    // se acumulan `TOPS_EVERY` ciclos de KPI.
    //
    // FIX: el intervalo de KPI ahora viene del servidor (refresh_seconds),
    // no estÃ¡ hardcodeado en 10 s.

    const TOPS_EVERY = IS_TV ? 2 : 6;  // en TV tops cada 2 ciclos
    let kpiIntervalMs = IS_TV ? 120_000 : 10_000;
    let kpiTimer      = null;
    let topsCounter   = 0;
    let lastSuccess   = null;  // timestamp del Ãºltimo fetch exitoso

    // â”€â”€ Loop robusto con auto-reconexiÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let consecutiveErrors = 0;
    const MAX_ERRORS = 10;

    function startKpiLoop(intervalMs) {
      if (kpiTimer) clearInterval(kpiTimer);
      kpiIntervalMs = intervalMs;
      startCountdown(intervalMs);
      kpiTimer = setInterval(tick, intervalMs);
    }

    // â”€â”€ Countdown visual â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let countdownEnd = 0;
    let countdownTimer = null;

    function startCountdown(intervalMs) {
      countdownEnd = Date.now() + intervalMs;
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        const rem = Math.max(0, Math.ceil((countdownEnd - Date.now()) / 1000));
        $("refreshCountdown").textContent = rem;
        const pct = ((countdownEnd - Date.now()) / kpiIntervalMs) * 100;
        $("refreshBar").style.width = Math.max(0, Math.min(100, pct)) + "%";
      }, 500);
    }

    // â”€â”€ Stale indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function markStale(isStale) {
      $("pillServer").classList.toggle("stale", isStale);
      // En TV: mostrar overlay de reconexiÃ³n si hay muchos errores
      if (IS_TV && isStale) {
        let overlay = document.getElementById('tvReconnect');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'tvReconnect';
          overlay.style.cssText = `
            position:fixed; inset:0; background:rgba(11,15,20,.85);
            display:flex; flex-direction:column; align-items:center;
            justify-content:center; z-index:9999; color:#e6edf3;
          `;
          overlay.innerHTML = '<div style="font-size:clamp(24px,3vw,48px);margin-bottom:16px">âš ï¸</div><div style="font-size:clamp(16px,2vw,28px);font-weight:700">Reconectandoâ€¦</div><div style="font-size:clamp(12px,1.2vw,18px);color:#9aa4b2;margin-top:8px">VerificÃ¡ la conexiÃ³n</div>';
          document.body.appendChild(overlay);
        }
      } else {
        const overlay = document.getElementById('tvReconnect');
        if (overlay) overlay.remove();
      }
    }

    // â”€â”€ Recarga de pÃ¡gina en TV si lleva mucho tiempo sin datos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let tvReloadTimer = null;
    let tvHadFirstSuccess = false;
    function resetTvReloadTimer() {
      if (!IS_TV || !tvHadFirstSuccess) return;
      if (tvReloadTimer) clearTimeout(tvReloadTimer);
      tvReloadTimer = setTimeout(() => {
        console.warn('TV: sin datos por 5min, recargando pÃ¡ginaâ€¦');
        location.reload();
      }, 5 * 60 * 1000);
    }

    // â”€â”€ GrÃ¡fico de flujo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateFlowChart(m) {
      // "A procesar" = en_preparacion + embalados (todo lo que aÃºn no saliÃ³)
      const prep  = (m.en_preparacion ?? 0) + (m.embalados ?? 0);
      const desp  = m.en_despacho    ?? 0;
      const env   = m.despachados_hoy ?? 0;
      const total = prep + desp + env;

      $("flowTotal").textContent = total > 0
        ? `${total.toLocaleString("es-AR")} pedidos en total`
        : "Sin datos";

      function setBar(barId, pctId, countId, val, suffix) {
        const pct = total > 0 ? (val / total) * 100 : 0;
        $(barId).style.width  = pct.toFixed(1) + "%";
        $(pctId).textContent  = pct.toFixed(1) + "%";
        $(countId).textContent = val.toLocaleString("es-AR") + suffix;
      }

      setBar("flowPrepBar", "flowPrepPct", "flowPrepCount", prep, " pedidos");
      setBar("flowDespBar", "flowDespPct", "flowDespCount", desp, " pedidos");
      setBar("flowEnvBar",  "flowEnvPct",  "flowEnvCount",  env,  " pedidos");
    }

    // â”€â”€ Actualizar KPIs en el DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyMetrics(m) {
      // Mostramos la hora local del cliente (prueba que el fetch funcionÃ³)
      // + antigÃ¼edad del snapshot para saber si /sync estÃ¡ corriendo.
      const fetchedAt = new Date().toLocaleTimeString("es-AR", { hour12: false });
      let snapshotAge = "";
      if (m.server_time_utc) {
        const ageSec = Math.round((Date.now() - new Date(m.server_time_utc).getTime()) / 1000);
        if (ageSec < 60)       snapshotAge = ` Â· sync hace ${ageSec}s`;
        else if (ageSec < 3600) snapshotAge = ` Â· sync hace ${Math.round(ageSec/60)}min`;
        else                    snapshotAge = ` Â· sync hace ${Math.round(ageSec/3600)}h`;
      }
      $("serverTime").textContent = fetchedAt + snapshotAge;

      $("kpiPrep").textContent         = (m.en_preparacion  ?? 0).toLocaleString("es-AR");
      $("kpiPack").textContent         = (m.embalados        ?? 0).toLocaleString("es-AR");
      $("kpiShip").textContent         = (m.en_despacho      ?? 0).toLocaleString("es-AR");
      $("kpiShippedToday").textContent = (m.despachados_hoy  ?? 0).toLocaleString("es-AR");
      $("kpiLate").textContent         = (m.atrasados_24h    ?? 0).toLocaleString("es-AR");
      $("kpiAvg").textContent          = (m.avg_age_min      ?? 0).toFixed(1);

      setBadge($("badgePrep"), (m.en_preparacion ?? 0) > 0 ? "warn" : "good",
               (m.en_preparacion ?? 0) > 0 ? "En cola"   : "OK");
      setBadge($("badgePack"), (m.embalados      ?? 0) > 0 ? "warn" : "good",
               (m.embalados      ?? 0) > 0 ? "Pendientes" : "OK");
      setBadge($("badgeShip"), (m.en_despacho    ?? 0) > 0 ? "warn" : "good",
               (m.en_despacho    ?? 0) > 0 ? "Pendientes" : "OK");
      const bl = badgeForLate(m.atrasados_24h ?? 0);
      setBadge($("badgeLate"), bl.cls, bl.text);
      updateFlowChart(m);
    }

    // â”€â”€ Tick principal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function tick() {
      startCountdown(kpiIntervalMs);
      topsCounter++;

      // KPIs
      try {
        const m = await fetchJson("/api/metrics");
        lastSuccess = Date.now();
        markStale(false);
        applyMetrics(m);

        // Reajustar intervalo si el servidor lo cambiÃ³
        const serverInterval = (m.refresh_seconds ?? 10) * 1000;
        if (serverInterval !== kpiIntervalMs) {
          startKpiLoop(serverInterval);
          return; // el nuevo loop arrancarÃ¡ con el intervalo correcto
        }
      } catch (e) {
        console.error("metrics error", e);
        consecutiveErrors++;
        if (consecutiveErrors >= MAX_ERRORS) {
          markStale(true);
        }
      }

      // Tops (menos frecuentes)
      if (topsCounter % TOPS_EVERY === 0) {
        await refreshTops();
      }
    }

    async function refreshTops() {
      await refreshAlerts();
      if (!IS_TV) await Promise.all([refreshProductivity(), refreshStageTimes(), refreshAllAnalytics()]);
      try {
        const tp = await fetchJson("/api/top-products?days=7&limit=10");
        $("topProductsWrap").innerHTML = renderTopProducts(tp);
        $("topProductsMeta").textContent = "Actualizado: " + new Date().toLocaleTimeString("es-AR", { hour12: false });
      } catch (e) {
        console.error("top-products error", e);
        $("topProductsWrap").innerHTML = `<div class="empty">Error cargando top artÃ­culos.</div>`;
      }

      try {
        const pk = await fetchJson("/api/top-packers?days=1&limit=6");
        $("topPackersWrap").innerHTML = renderTopPackers(pk);
        $("topPackersMeta").textContent = "Actualizado: " + new Date().toLocaleTimeString("es-AR", { hour12: false });
      } catch (e) {
        console.error("top-packers error", e);
        $("topPackersWrap").innerHTML = `<div class="empty">Error cargando top embaladores.</div>`;
      }

    }



    // â”€â”€ Alertas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let alertOpen = false;
    let alertData = [];

    function toggleAlertDetail() {
      alertOpen = !alertOpen;
      const det = $('alertDetail');
      const exp = $('alertExpand');
      det.classList.toggle('open', alertOpen);
      exp.textContent = alertOpen ? 'â–² Ocultar' : 'â–¼ Ver detalle';
    }

    function renderAlertDetail(orders) {
      if (!orders || orders.length === 0) {
        $('alertDetail').innerHTML = '';
        return;
      }
      const rows = orders.map(o => {
        const prods = (o.products || []).map(p => `${escapeHtml(p.name)} Ã—${p.quantity}`).join(', ');
        const hs = Math.floor(o.mins / 60);
        const ms = Math.round(o.mins % 60);
        const timeStr = hs > 0 ? `${hs}h ${ms}m` : `${ms}m`;
        return `<tr>
          <td><b>#${escapeHtml(o.order_id)}</b></td>
          <td>${escapeHtml(o.status)}</td>
          <td class="alert-mins">${timeStr}</td>
          <td style="color:var(--muted);font-size:12px">${escapeHtml(prods)}</td>
        </tr>`;
      }).join('');
      $('alertDetail').innerHTML = `
        <table>
          <thead><tr><th>Pedido</th><th>Estado</th><th>Tiempo</th><th>Productos</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    async function refreshAlerts() {
      try {
        const data = await fetchJson('/api/alerts');
        const banner = $('alertBanner');
        if (data.count > 0) {
          banner.classList.add('visible');
          $('alertTitle').textContent = `âš ï¸ ${data.count} pedido${data.count > 1 ? 's' : ''} hace mÃ¡s de 2hs en preparaciÃ³n`;
          const oldest = data.orders[0];
          const hs = Math.floor(oldest.mins / 60);
          const ms = Math.round(oldest.mins % 60);
          $('alertSub').textContent = `El mÃ¡s antiguo: #${oldest.order_id} â€” ${hs}h ${ms}m en "${oldest.status}"`;
          alertData = data.orders;
          if (alertOpen) renderAlertDetail(alertData);
        } else {
          banner.classList.remove('visible');
          $('alertDetail').classList.remove('open');
          alertOpen = false;
        }
      } catch(e) { console.error('alerts error', e); }
    }

    // â”€â”€ Productividad â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function fmtDay(dateStr) {
      const d = new Date(dateStr + 'T12:00:00');
      return d.toLocaleDateString('es-AR', { weekday: 'short', day: 'numeric', month: 'short' });
    }

    async function refreshProductivity() {
      try {
        const data = await fetchJson('/api/productivity?days=7');
        if (!data || data.length === 0) {
          $('productivityChart').innerHTML = '<div class="empty">Sin datos todavÃ­a.</div>';
          return;
        }
        const max = Math.max(...data.map(d => d.shipped), 1);
        const bars = data.map(d => `
          <div class="bar-row">
            <div class="bar-label">${fmtDay(d.day)}</div>
            <div class="bar-track">
              <div class="bar-fill" style="width:${Math.round(d.shipped/max*100)}%"></div>
            </div>
            <div class="bar-val">${d.shipped}</div>
          </div>`).join('');
        $('productivityChart').innerHTML = bars;
        $('productivityMeta').textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-AR', { hour12: false });
      } catch(e) { console.error('productivity error', e); }
    }

    // â”€â”€ Tiempos por etapa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function timePillClass(mins) {
      if (mins < 30)  return 'time-good';
      if (mins < 120) return 'time-warn';
      return 'time-bad';
    }

    function fmtAvgTime(mins) {
      if (mins < 60) return Math.round(mins) + ' min';
      return Math.floor(mins/60) + 'h ' + Math.round(mins%60) + 'm';
    }

    async function refreshStageTimes() {
      try {
        const data = await fetchJson('/api/stage-times?days=7');
        if (!data || data.length === 0) {
          $('stageTimesWrap').innerHTML = '<div class="empty">Sin datos suficientes todavÃ­a.</div>';
          return;
        }
        const rows = data.map(d => `
          <tr>
            <td class="stage-name">${escapeHtml(d.stage)}</td>
            <td><span class="time-pill ${timePillClass(d.avg_mins)}">${fmtAvgTime(d.avg_mins)}</span></td>
            <td class="num"><span class="time-pill ${timePillClass(d.median_mins)}">${fmtAvgTime(d.median_mins)}</span></td>
            <td class="num muted">${d.sample}</td>
          </tr>`).join('');
        $('stageTimesWrap').innerHTML = `
          <table class="stage-table">
            <thead><tr><th>Etapa</th><th>Promedio</th><th>Mediana</th><th class="num">Muestra</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>`;
        $('stageTimesMeta').textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-AR', { hour12: false });
      } catch(e) { console.error('stage-times error', e); }
    }


    // â”€â”€ Unidades en preparaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refreshUnitsPrep() {
      try {
        const d = await fetchJson('/api/units-in-prep');
        $('unitsPrepVal').textContent = Number(d.total_units).toLocaleString('es-AR');
        $('unitsPrepSub').textContent = d.total_orders + ' pedidos activos';
        $('unitsPrepMeta').textContent = new Date().toLocaleTimeString('es-AR', { hour12: false });
      } catch(e) { console.error('units-in-prep error', e); }
    }

    // â”€â”€ Velocidad de despacho â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refreshDispatchRate() {
      try {
        const data = await fetchJson('/api/dispatch-rate');
        if (!data || data.length === 0) { $('dispatchRateChart').innerHTML = '<div class="empty">Sin datos.</div>'; return; }
        const max = Math.max(...data.map(d => d.shipped), 1);
        const bars = data.map(d => {
          const h = new Date(d.hour).getHours();
          const pct = Math.round(d.shipped / max * 100);
          return `<div class="rate-bar-wrap">
            <div class="rate-bar-val">${d.shipped}</div>
            <div class="rate-bar" style="height:${pct}%"></div>
            <div class="rate-bar-label">${h}hs</div>
          </div>`;
        }).join('');
        $('dispatchRateChart').innerHTML = bars;
        $('dispatchRateMeta').textContent = new Date().toLocaleTimeString('es-AR', { hour12: false });
      } catch(e) { console.error('dispatch-rate error', e); }
    }

    // â”€â”€ Pedidos sin movimiento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refreshStalled() {
      try {
        const d = await fetchJson('/api/stalled-orders?hours=4');
        $('stalledCount').textContent = d.count > 0 ? `(${d.count})` : '';
        if (d.count === 0) { $('stalledList').innerHTML = '<div class="empty">âœ“ Todos los pedidos con movimiento reciente.</div>'; return; }
        const items = d.orders.slice(0, 8).map(o => {
          const hs = Math.floor(o.mins/60), ms = Math.round(o.mins%60);
          const t = hs > 0 ? `${hs}h ${ms}m` : `${ms}m`;
          return `<div class="backtrack-item">
            <span class="backtrack-order">#${escapeHtml(o.order_id)}</span>
            <span class="status-badge ${statusClass(o.status)}">${escapeHtml(o.status)}</span>
            <span class="mins-badge mins-bad">${t}</span>
          </div>`;
        }).join('');
        $('stalledList').innerHTML = items;
        $('stalledMeta').textContent = new Date().toLocaleTimeString('es-AR', { hour12: false });
      } catch(e) { console.error('stalled-orders error', e); }
    }

    // â”€â”€ Comparativa semanal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refreshWeekly() {
      try {
        const data = await fetchJson('/api/weekly-comparison');
        if (!data || data.length === 0) { $('weeklyChart').innerHTML = '<div class="empty">Sin datos.</div>'; return; }
        const max = Math.max(...data.flatMap(d => [d.this_week, d.last_week]), 1);
        const rows = data.map(d => `
          <div class="comp-row">
            <div class="comp-day">${d.weekday}</div>
            <div class="comp-bars">
              <div class="comp-bar-row">
                <div class="comp-bar-fill this" style="width:${Math.round(d.this_week/max*120)}px"></div>
                <span class="comp-val">${d.this_week}</span>
              </div>
              <div class="comp-bar-row">
                <div class="comp-bar-fill last" style="width:${Math.round(d.last_week/max*120)}px"></div>
                <span class="comp-val" style="opacity:.5">${d.last_week}</span>
              </div>
            </div>
          </div>`).join('');
        $('weeklyChart').innerHTML = rows + `<div style="font-size:11px;color:var(--muted);margin-top:6px">
          <span style="color:#58a6ff">â– </span> Esta semana &nbsp;
          <span style="color:rgba(88,166,255,.4)">â– </span> Semana anterior
        </div>`;
        $('weeklyMeta').textContent = new Date().toLocaleTimeString('es-AR', { hour12: false });
      } catch(e) { console.error('weekly error', e); }
    }

    // â”€â”€ Hora pico â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refreshPeakHours() {
      try {
        const data = await fetchJson('/api/peak-hours?days=7');
        const max = Math.max(...data.map(d => d.shipped), 1);
        const peakHour = data.reduce((a, b) => b.shipped > a.shipped ? b : a, data[0]).hour;
        const bars = data.map(d => `
          <div class="peak-bar-wrap">
            <div class="peak-bar ${d.hour === peakHour ? 'highlight' : ''}"
                 style="height:${Math.round(d.shipped/max*100)}%"></div>
            <div class="peak-label">${d.hour % 3 === 0 ? d.hour+'h' : ''}</div>
          </div>`).join('');
        $('peakChart').innerHTML = bars;
        $('peakMeta').textContent = `Pico: ${peakHour}hs`;
      } catch(e) { console.error('peak-hours error', e); }
    }

    // â”€â”€ Cancelaciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refreshCancellations() {
      try {
        const data = await fetchJson('/api/cancellation-rate?days=7');
        if (!data || data.length === 0) { $('cancelWrap').innerHTML = '<div class="empty">Sin datos.</div>'; return; }
        const rows = data.map(d => {
          const rateClass = d.rate > 10 ? 'bad' : d.rate > 5 ? 'warn' : 'good';
          return `<tr>
            <td>${d.day}</td>
            <td class="num">${d.total}</td>
            <td class="num">${d.cancelled}</td>
            <td class="num"><span class="badge ${rateClass}">${d.rate}%</span></td>
          </tr>`;
        }).join('');
        $('cancelWrap').innerHTML = `<table class="cancel-table">
          <thead><tr><th>DÃ­a</th><th class="num">Total</th><th class="num">Cancel.</th><th class="num">Tasa</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
        $('cancelMeta').textContent = new Date().toLocaleTimeString('es-AR', { hour12: false });
      } catch(e) { console.error('cancellations error', e); }
    }

    // â”€â”€ Pedidos que volvieron atrÃ¡s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refreshBacktracked() {
      try {
        const d = await fetchJson('/api/backtracked-orders?days=7');
        $('backtrackCount').textContent = d.count > 0 ? `(${d.count})` : '';
        if (d.count === 0) { $('backtrackList').innerHTML = '<div class="empty">âœ“ Sin retrocesos en los Ãºltimos 7 dÃ­as.</div>'; return; }
        const items = d.orders.slice(0, 8).map(o => `
          <div class="backtrack-item">
            <span class="backtrack-order">#${escapeHtml(o.order_id)}</span>
            <span class="backtrack-arrow">â†©</span>
            <span class="status-badge status-prep">${escapeHtml(o.status)}</span>
            <span style="font-size:11px;color:var(--muted)">${fmtTime(o.ts)}</span>
          </div>`).join('');
        $('backtrackList').innerHTML = items;
        $('backtrackMeta').textContent = new Date().toLocaleTimeString('es-AR', { hour12: false });
      } catch(e) { console.error('backtracked error', e); }
    }

    // â”€â”€ Tiempo hasta primer movimiento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refreshTTFM() {
      try {
        const d = await fetchJson('/api/time-to-first-move?days=7');
        const fmt = m => m < 60 ? Math.round(m) + ' min' : Math.floor(m/60) + 'h ' + Math.round(m%60) + 'm';
        $('ttfmVal').textContent = fmt(d.avg_mins);
        $('ttfmSub').textContent = `Mediana: ${fmt(d.median_mins)} Â· Muestra: ${d.sample} pedidos`;
      } catch(e) { console.error('ttfm error', e); }
    }

    async function refreshAllAnalytics() {
      await Promise.all([
        refreshUnitsPrep(),
        refreshDispatchRate(),
        refreshStalled(),
        refreshWeekly(),
        refreshPeakHours(),
        refreshCancellations(),
        refreshBacktracked(),
        refreshTTFM(),
      ]);
    }

    // â”€â”€ Pedidos pendientes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let pendingData = [];
    let activeFilter = 'all';
    const PREP_STATUSES  = ["Turbo","Flex","Colecta","Recolectando","Nuevos pedidos","Agendados","A distribuir","error de etiqueta"];
    const EMBAL_STATUSES = ["Puesto 1","Puesto 2","Puesto 3","Puesto 4","Puesto 5","Puesto 6","Embalado"];
    const DESP_STATUSES  = ["Mercado EnvÃ­os","LogÃ­stica propia","Blitzz","Zeta","Eliazar","Federico"];

    function statusClass(status) {
      if (PREP_STATUSES.includes(status))  return 'status-prep';
      if (EMBAL_STATUSES.includes(status)) return 'status-embal';
      if (DESP_STATUSES.includes(status))  return 'status-desp';
      return '';
    }

    function filterGroup(status) {
      if (PREP_STATUSES.includes(status))  return 'prep';
      if (EMBAL_STATUSES.includes(status)) return 'embal';
      if (DESP_STATUSES.includes(status))  return 'desp';
      return 'other';
    }

    function minsClass(mins) {
      if (mins < 30)  return 'mins-ok';
      if (mins < 120) return 'mins-warn';
      return 'mins-bad';
    }

    function fmtMins(mins) {
      if (mins < 60) return mins + ' min';
      const h = Math.floor(mins / 60);
      const m = Math.round(mins % 60);
      return h + 'h ' + (m > 0 ? m + 'm' : '');
    }

    function setFilter(f, btn) {
      activeFilter = f;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderPending();
    }

    function filterPending() { renderPending(); }

    function renderPending() {
      const q = ($('pendingSearch').value || '').toLowerCase();
      const filtered = pendingData.filter(o => {
        if (activeFilter !== 'all' && filterGroup(o.status) !== activeFilter) return false;
        if (!q) return true;
        if (o.order_id.includes(q)) return true;
        return (o.products || []).some(p =>
          (p.name || '').toLowerCase().includes(q) ||
          (p.sku  || '').toLowerCase().includes(q)
        );
      });

      $('pendingCount').textContent = '(' + filtered.length + ')';

      if (filtered.length === 0) {
        $('pendingTableWrap').innerHTML = '<div class="empty">Sin resultados.</div>';
        return;
      }

      const rows = filtered.map(o => {
        const prods = (o.products || []).map(p =>
          `<span>${escapeHtml(p.name)} <b>Ã—${p.quantity}</b>${p.sku && p.sku !== '(sin sku)' ? ' <span style="opacity:.6">['+escapeHtml(p.sku)+']</span>' : ''}</span>`
        ).join('<br>');
        return `<tr>
          <td><span class="order-id">#${escapeHtml(o.order_id)}</span></td>
          <td><span class="status-badge ${statusClass(o.status)}">${escapeHtml(o.status)}</span></td>
          <td><span class="mins-badge ${minsClass(o.mins_in_status)}">${fmtMins(o.mins_in_status)}</span></td>
          <td><div class="products-list">${prods || '<span style="opacity:.4">Sin productos</span>'}</div></td>
        </tr>`;
      }).join('');

      $('pendingTableWrap').innerHTML = `
        <table>
          <thead>
            <tr>
              <th style="width:110px">Pedido</th>
              <th style="width:130px">Estado</th>
              <th style="width:90px">Tiempo</th>
              <th>Productos</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    async function refreshPending() {
      try {
        pendingData = await fetchJson('/api/pending-orders?limit=500');
        renderPending();
        $('pendingMeta').textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-AR', { hour12: false });
      } catch(e) {
        console.error('pending-orders error', e);
        $('pendingTableWrap').innerHTML = '<div class="empty">Error cargando pedidos.</div>';
      }
    }


    // â”€â”€ Arranque â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Primer render inmediato (incluyendo tops), luego arranca el loop
    (async () => {
      try {
        const m = await fetchJson("/api/metrics");
        lastSuccess = Date.now();
        applyMetrics(m);
        const serverInterval = (m.refresh_seconds ?? 10) * 1000;
        startKpiLoop(serverInterval);
      } catch (e) {
        console.error("init metrics error", e);
        startKpiLoop(kpiIntervalMs); // arranca igual con default
      }
      await refreshTops();
      await refreshPending();
      await refreshAlerts();
      if (!IS_TV) { await refreshProductivity(); await refreshStageTimes(); await refreshAllAnalytics(); }
    })();

  </script>
</body>
</html>