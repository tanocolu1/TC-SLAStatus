<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Depósito Dashboard</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111826;
      --card2:#0f1724;
      --text:#e6edf3;
      --muted:#9aa4b2;
      --line:rgba(255,255,255,.08);
      --good:#1f9d55;
      --warn:#e0a800;
      --bad:#d64545;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 30% -10%, rgba(42,82,152,.25), transparent 60%),
                  radial-gradient(900px 700px at 90% 20%, rgba(38,166,154,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      padding: 22px 22px 28px;
      max-width: 1500px;
      margin: 0 auto;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 14px;
    }
    .title{
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .meta{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:12px;
      align-items:center;
    }
    .pill{
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.03);
    }
    /* FIX: indicador visual de último refresco */
    .pill.stale{ border-color: rgba(214,69,69,.45); color: #ffb3b3; }

    .grid-kpi{
      display:grid;
      grid-template-columns: repeat(5, minmax(180px, 1fr));
      gap: 12px;
      margin: 12px 0 14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px 12px;
      min-height: 88px;
    }
    .kpi-label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .kpi-value{
      font-size: 34px;
      font-weight: 800;
      line-height: 1;
      letter-spacing: -0.6px;
    }
    .kpi-sub{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .badge{
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      white-space: nowrap;
    }
    .badge.good{ color: #b5f5cf; border-color: rgba(31,157,85,.35); background: rgba(31,157,85,.12); }
    .badge.warn{ color: #ffe8a3; border-color: rgba(224,168,0,.35); background: rgba(224,168,0,.12); }
    .badge.bad { color: #ffb3b3; border-color: rgba(214,69,69,.35); background: rgba(214,69,69,.12); }

    .grid-bottom{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    .card-title{
      font-size: 14px;
      font-weight: 750;
      margin: 0 0 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .card-title span{
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
    }
    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td{
      text-align:left;
      padding: 10px 8px;
      border-top: 1px solid var(--line);
      vertical-align: top;
    }
    th{
      color: var(--muted);
      font-weight: 650;
      border-top: none;
      padding-top: 6px;
    }
    td.num, th.num{ text-align:right; }
    .muted{ color: var(--muted); }
    .row-rank{
      width: 30px;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }
    .sku{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #c7d2fe;
    }
    .name{ font-weight: 650; }
    .empty{
      padding: 14px 10px;
      color: var(--muted);
      border-top: 1px solid var(--line);
    }

    /* FIX: barra de progreso del countdown */
    .refresh-bar-wrap{
      height: 2px;
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 14px;
    }
    .refresh-bar{
      height: 100%;
      background: rgba(38,166,154,.6);
      transition: width .9s linear;
    }

    @media (max-width: 1200px){
      .grid-kpi{ grid-template-columns: repeat(2, minmax(180px, 1fr)); }
      .grid-bottom{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Depósito · Dashboard</div>
      <div class="meta">
        <!-- FIX: muestra countdown en lugar del intervalo fijo -->
        <div class="pill" id="pillCountdown">Próximo refresh en <span id="refreshCountdown">—</span>s</div>
        <div class="pill" id="pillServer">Servidor <span id="serverTime">—</span></div>
      </div>
    </div>

    <!-- FIX: barra visual de progreso del countdown -->
    <div class="refresh-bar-wrap">
      <div class="refresh-bar" id="refreshBar" style="width:100%"></div>
    </div>

    <div class="grid-kpi">
      <div class="card">
        <div class="kpi-label">
          <div>En preparación</div>
          <div class="badge" id="badgePrep">—</div>
        </div>
        <div class="kpi-value" id="kpiPrep">—</div>
        <div class="kpi-sub muted">Nuevos + Recepción + Preparación</div>
      </div>

      <div class="card">
        <div class="kpi-label">
          <div>Embalados</div>
          <div class="badge" id="badgePack">—</div>
        </div>
        <div class="kpi-value" id="kpiPack">—</div>
        <div class="kpi-sub muted">Puestos + "Embalado"</div>
      </div>

      <div class="card">
        <div class="kpi-label">
          <div>En despacho</div>
          <div class="badge" id="badgeShip">—</div>
        </div>
        <div class="kpi-value" id="kpiShip">—</div>
        <div class="kpi-sub muted">Transportes / Pickup</div>
      </div>

      <div class="card">
        <div class="kpi-label">
          <div>Despachados hoy</div>
          <div class="badge good">Enviado</div>
        </div>
        <div class="kpi-value" id="kpiShippedToday">—</div>
        <div class="kpi-sub muted">Pedidos únicos "Enviado" hoy</div>
      </div>

      <div class="card">
        <div class="kpi-label">
          <div>Atrasados +24h</div>
          <div class="badge" id="badgeLate">—</div>
        </div>
        <div class="kpi-value" id="kpiLate">—</div>
        <div class="kpi-sub muted">Edad promedio: <span id="kpiAvg">—</span> min</div>
      </div>
    </div>

    <div class="grid-bottom">
      <div class="card">
        <div class="card-title">
          <div>Top 10 artículos vendidos <span>(últimos 7 días)</span></div>
          <span class="muted" id="topProductsMeta">—</span>
        </div>
        <div id="topProductsWrap"><div class="empty">Cargando…</div></div>
      </div>

      <div class="card">
        <div class="card-title">
          <div>Top 6 embaladores <span>(hoy)</span></div>
          <span class="muted" id="topPackersMeta">—</span>
        </div>
        <div id="topPackersWrap"><div class="empty">Cargando…</div></div>
      </div>
    </div>
  </div>

  <script>
    // ─── Utilidades ────────────────────────────────────────────────────────────

    const $ = (id) => document.getElementById(id);

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&",  "&amp;")
        .replaceAll("<",  "&lt;")
        .replaceAll(">",  "&gt;")
        .replaceAll('"',  "&quot;")
        .replaceAll("'",  "&#039;");
    }

    function fmtTime(iso) {
      try {
        return new Date(iso).toLocaleString("es-AR", { hour12: false });
      } catch (_) {
        return iso || "—";
      }
    }

    function badgeForLate(n) {
      if (n <= 0) return { cls: "good", text: "OK" };
      if (n <= 5) return { cls: "warn", text: "Atención" };
      return { cls: "bad", text: "Crítico" };
    }

    function setBadge(el, cls, text) {
      el.className = "badge " + (cls || "");
      el.textContent = text;
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`${url} → ${res.status}`);
      return res.json();
    }

    // ─── Renderers ─────────────────────────────────────────────────────────────

    function renderTopProducts(items) {
      if (!items || items.length === 0) {
        return `<div class="empty">Sin datos todavía (corré /sync o esperá el cron).</div>`;
      }
      const rows = items.map((it, idx) => `
        <tr>
          <td class="row-rank">${idx + 1}</td>
          <td>
            <div class="name">${escapeHtml(it.name || "")}</div>
            <div class="sku">${escapeHtml(it.sku || "")}</div>
          </td>
          <td class="num">${Number(it.units  || 0).toLocaleString("es-AR")}</td>
          <td class="num muted">${Number(it.orders || 0).toLocaleString("es-AR")}</td>
        </tr>`).join("");

      return `
        <table>
          <thead>
            <tr>
              <th style="width:32px">#</th>
              <th>Artículo</th>
              <th class="num">Unid.</th>
              <th class="num">Pedidos</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    function renderTopPackers(items) {
      if (!items || items.length === 0) {
        return `<div class="empty">Sin datos todavía (no hubo movimientos a Puestos o faltan eventos).</div>`;
      }
      const rows = items.map((it, idx) => `
        <tr>
          <td class="row-rank">${idx + 1}</td>
          <td class="name">${escapeHtml(it.packer || "")}</td>
          <td class="num">${Number(it.orders_packed || 0).toLocaleString("es-AR")}</td>
        </tr>`).join("");

      return `
        <table>
          <thead>
            <tr>
              <th style="width:32px">#</th>
              <th>Embalador</th>
              <th class="num">Pedidos</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    // ─── Lógica de refresco ────────────────────────────────────────────────────
    //
    // FIX: antes había DOS setInterval paralelos que llamaban a /api/metrics,
    // uno cada 60 s (refreshAll completo) y otro cada 10 s solo para KPIs,
    // duplicando código y peticiones.
    // Ahora hay UN solo ciclo: KPIs cada `kpiIntervalMs`, tops cada vez que
    // se acumulan `TOPS_EVERY` ciclos de KPI.
    //
    // FIX: el intervalo de KPI ahora viene del servidor (refresh_seconds),
    // no está hardcodeado en 10 s.

    const TOPS_EVERY = 6;   // tops se recargan cada 6 × kpiInterval
    let kpiIntervalMs = 10_000;
    let kpiTimer      = null;
    let topsCounter   = 0;
    let lastSuccess   = null;  // timestamp del último fetch exitoso

    function startKpiLoop(intervalMs) {
      if (kpiTimer) clearInterval(kpiTimer);
      kpiIntervalMs = intervalMs;
      startCountdown(intervalMs);
      kpiTimer = setInterval(tick, intervalMs);
    }

    // ── Countdown visual ───────────────────────────────────────────────────────
    let countdownEnd = 0;
    let countdownTimer = null;

    function startCountdown(intervalMs) {
      countdownEnd = Date.now() + intervalMs;
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        const rem = Math.max(0, Math.ceil((countdownEnd - Date.now()) / 1000));
        $("refreshCountdown").textContent = rem;
        const pct = ((countdownEnd - Date.now()) / kpiIntervalMs) * 100;
        $("refreshBar").style.width = Math.max(0, Math.min(100, pct)) + "%";
      }, 500);
    }

    // ── Stale indicator: si pasan 3 × intervalo sin respuesta ─────────────────
    function markStale(isStale) {
      $("pillServer").classList.toggle("stale", isStale);
    }

    // ── Actualizar KPIs en el DOM ──────────────────────────────────────────────
    function applyMetrics(m) {
      $("serverTime").textContent = fmtTime(m.server_time_utc);

      $("kpiPrep").textContent         = (m.en_preparacion  ?? 0).toLocaleString("es-AR");
      $("kpiPack").textContent         = (m.embalados        ?? 0).toLocaleString("es-AR");
      $("kpiShip").textContent         = (m.en_despacho      ?? 0).toLocaleString("es-AR");
      $("kpiShippedToday").textContent = (m.despachados_hoy  ?? 0).toLocaleString("es-AR");
      $("kpiLate").textContent         = (m.atrasados_24h    ?? 0).toLocaleString("es-AR");
      $("kpiAvg").textContent          = (m.avg_age_min      ?? 0).toFixed(1);

      setBadge($("badgePrep"), (m.en_preparacion ?? 0) > 0 ? "warn" : "good",
               (m.en_preparacion ?? 0) > 0 ? "En cola"   : "OK");
      setBadge($("badgePack"), (m.embalados      ?? 0) > 0 ? "warn" : "good",
               (m.embalados      ?? 0) > 0 ? "Pendientes" : "OK");
      setBadge($("badgeShip"), (m.en_despacho    ?? 0) > 0 ? "warn" : "good",
               (m.en_despacho    ?? 0) > 0 ? "Pendientes" : "OK");
      const bl = badgeForLate(m.atrasados_24h ?? 0);
      setBadge($("badgeLate"), bl.cls, bl.text);
    }

    // ── Tick principal ─────────────────────────────────────────────────────────
    async function tick() {
      startCountdown(kpiIntervalMs);
      topsCounter++;

      // KPIs
      try {
        const m = await fetchJson("/api/metrics");
        lastSuccess = Date.now();
        markStale(false);
        applyMetrics(m);

        // Reajustar intervalo si el servidor lo cambió
        const serverInterval = (m.refresh_seconds ?? 10) * 1000;
        if (serverInterval !== kpiIntervalMs) {
          startKpiLoop(serverInterval);
          return; // el nuevo loop arrancará con el intervalo correcto
        }
      } catch (e) {
        console.error("metrics error", e);
        // FIX: marcar como stale si llevamos 3 ciclos sin respuesta
        if (lastSuccess && Date.now() - lastSuccess > kpiIntervalMs * 3) {
          markStale(true);
        }
      }

      // Tops (menos frecuentes)
      if (topsCounter % TOPS_EVERY === 0) {
        await refreshTops();
      }
    }

    async function refreshTops() {
      try {
        const tp = await fetchJson("/api/top-products?days=7&limit=10");
        $("topProductsWrap").innerHTML = renderTopProducts(tp);
        $("topProductsMeta").textContent = "Actualizado: " + new Date().toLocaleTimeString("es-AR", { hour12: false });
      } catch (e) {
        console.error("top-products error", e);
        $("topProductsWrap").innerHTML = `<div class="empty">Error cargando top artículos.</div>`;
      }

      try {
        const pk = await fetchJson("/api/top-packers?days=1&limit=6");
        $("topPackersWrap").innerHTML = renderTopPackers(pk);
        $("topPackersMeta").textContent = "Actualizado: " + new Date().toLocaleTimeString("es-AR", { hour12: false });
      } catch (e) {
        console.error("top-packers error", e);
        $("topPackersWrap").innerHTML = `<div class="empty">Error cargando top embaladores.</div>`;
      }
    }

    // ── Arranque ───────────────────────────────────────────────────────────────
    // Primer render inmediato (incluyendo tops), luego arranca el loop
    (async () => {
      try {
        const m = await fetchJson("/api/metrics");
        lastSuccess = Date.now();
        applyMetrics(m);
        const serverInterval = (m.refresh_seconds ?? 10) * 1000;
        startKpiLoop(serverInterval);
      } catch (e) {
        console.error("init metrics error", e);
        startKpiLoop(kpiIntervalMs); // arranca igual con default
      }
      await refreshTops();
    })();
  </script>
</body>
</html>